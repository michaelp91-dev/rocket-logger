<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model Rocket Flight Log & Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { margin: 5% auto; width: 95%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .input-group label { font-size: 0.9rem; }
        .result-value { font-weight: 700; font-size: 1.5rem; }
        .result-unit { font-size: 0.9rem; color: #9ca3af; }
        .item-list-button { cursor: pointer; padding: 0.75rem 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        .item-list-button:hover { background-color: #374151; }
        .item-list-button.selected { background-color: #1d4ed8; }
        .modal-body::-webkit-scrollbar, .table-container::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-thumb, .table-container::-webkit-scrollbar-thumb { background-color: #4f46e5; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Rocket Flight Center</h1>
            <p class="text-gray-400 mt-2">Manage your fleet, log flights, and analyze performance.</p>
        </header>

        <!-- Main Controls -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <button id="manageRocketsBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg">Manage Rockets</button>
            <button id="manageEnginesBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-3 rounded-lg">Manage Engines</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="startPreFlightBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg">ðŸš€ Start Pre-Flight</button>
            <button id="viewFlightLogBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg">ðŸ“‹ View Flight Log</button>
        </div>
    </div>

    <!-- Universal Management Modal (for Rockets/Engines) -->
    <div id="manageModal" class="modal">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl">
            <div class="p-6 border-b border-gray-700">
                 <h2 id="modalTitle" class="text-2xl font-bold text-cyan-400">Manage</h2>
            </div>
            <div class="modal-body p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-gray-900/50 p-3 rounded-lg">
                        <h3 class="font-semibold mb-2">Saved Profiles</h3>
                        <div id="itemList" class="space-y-1 max-h-96 overflow-y-auto"></div>
                        <button id="newItemBtn" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">New</button>
                    </div>
                    <div id="formContainer" class="md:col-span-2 space-y-4"></div>
                </div>
            </div>
             <div class="flex justify-end gap-4 mt-auto p-6 border-t border-gray-700">
                <button id="deleteItemBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg hidden mr-auto">Delete</button>
                <button class="close-modal-btn bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">Close</button>
                <button id="saveItemBtn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <!-- Pre-Flight Modal -->
    <div id="preFlightModal" class="modal">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6">
            <h2 class="text-2xl font-bold text-cyan-400 mb-6">Start a New Pre-Flight Check</h2>
            <div class="space-y-4">
                <div>
                    <label for="preFlightRocketSelect" class="block mb-1 text-sm font-medium text-gray-400">Select Rocket</label>
                    <select id="preFlightRocketSelect" class="w-full bg-gray-700 rounded p-2"></select>
                </div>
                <div>
                    <label for="preFlightEngineSelect" class="block mb-1 text-sm font-medium text-gray-400">Select Engine</label>
                    <select id="preFlightEngineSelect" class="w-full bg-gray-700 rounded p-2"></select>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8 border-t border-gray-700 pt-4">
                <button class="close-modal-btn bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="savePreFlightBtn" class="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Save Pre-Flight & Estimate</button>
            </div>
        </div>
    </div>

    <!-- Flight Log Modal -->
    <div id="flightLogModal" class="modal">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl">
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-2xl font-bold text-cyan-400">Flight Log</h2>
            </div>
            <div class="modal-body p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-gray-900/50 p-3 rounded-lg">
                        <h3 class="font-semibold mb-2">Logged Flights</h3>
                        <div id="flightList" class="space-y-1 max-h-[65vh] overflow-y-auto"></div>
                    </div>
                    <div id="flightDetailsContainer" class="md:col-span-2 space-y-4">
                        <div class="text-center text-gray-400 p-8">Select a flight to view details.</div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-auto p-6 border-t border-gray-700">
                <button class="close-modal-btn bg-gray-600 hover:bg-gray-500 font-bold py-2 px-4 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURES ---
        let rocketList = [];
        let engineList = [];
        let flightLog = [];
        let currentModalType = null;
        let editingItemId = null;

        // --- ROCKET SCIENCE CLASSES (Unchanged) ---
        class Rocket {
            constructor(data) {
                this.dry_mass = parseFloat(data.dry_mass_g) / 1000.0;
                this.diameter = parseFloat(data.diameter_cm) / 100.0;
                this.radius = this.diameter / 2.0;
                this.nose_cone_length = parseFloat(data.nose_cone_length_cm) / 100.0;
                this.cog = parseFloat(data.cog_cm) / 100.0;
                this.num_fins = parseInt(data.num_fins);
                this.fin_root_chord = parseFloat(data.fin_root_chord_cm) / 100.0;
                this.fin_tip_chord = parseFloat(data.fin_tip_chord_cm) / 100.0;
                this.fin_semi_span = parseFloat(data.fin_semi_span_cm) / 100.0;
                this.fin_sweep_dist = parseFloat(data.fin_sweep_dist_cm) / 100.0;
                this.nose_to_fin_dist = parseFloat(data.nose_to_fin_dist_cm) / 100.0;
                this.fin_mid_chord_length = this._calculate_mid_chord_length();
            }
            _calculate_mid_chord_length() {
                const x1 = 0, y1 = this.fin_root_chord / 2.0, x2 = this.fin_semi_span, y2 = (this.fin_tip_chord / 2.0) + this.fin_sweep_dist;
                return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            }
            calculate_cop() {
                const cn_nose = 2.0, cp_nose = 0.666 * this.nose_cone_length;
                const interference = 1 + (this.radius / (this.fin_semi_span + this.radius));
                const cn_fins = interference * ((4 * this.num_fins * Math.pow(this.fin_semi_span / this.diameter, 2)) / (1 + Math.sqrt(1 + Math.pow(2 * this.fin_mid_chord_length / (this.fin_root_chord + this.fin_tip_chord), 2))));
                const term1 = this.fin_sweep_dist / 3.0 * (this.fin_root_chord + 2 * this.fin_tip_chord) / (this.fin_root_chord + this.fin_tip_chord);
                const term2 = (1.0 / 6.0) * (this.fin_root_chord + this.fin_tip_chord - (this.fin_root_chord * this.fin_tip_chord) / (this.fin_root_chord + this.fin_tip_chord));
                const cp_fins = this.nose_to_fin_dist + term1 + term2;
                return ((cn_nose * cp_nose) + (cn_fins * cp_fins)) / (cn_nose + cn_fins);
            }
        }
        class Motor {
            constructor(data) {
                this.initial_mass = parseFloat(data.motor_initial_mass_g) / 1000.0;
                this.propellant_mass = parseFloat(data.motor_propellant_mass_g) / 1000.0;
                this.avg_thrust = parseFloat(data.motor_avg_thrust_n);
                this.burn_time = parseFloat(data.motor_burn_time_s);
                this.impulse = this.avg_thrust * this.burn_time;
            }
        }

        // --- LOCALSTORAGE & DATA HANDLING ---
        function loadAllData() {
            rocketList = JSON.parse(localStorage.getItem('rocketList')) || [];
            engineList = JSON.parse(localStorage.getItem('engineList')) || [];
            flightLog = JSON.parse(localStorage.getItem('flightLog')) || [];
        }

        function saveAllData() {
            localStorage.setItem('rocketList', JSON.stringify(rocketList));
            localStorage.setItem('engineList', JSON.stringify(engineList));
            localStorage.setItem('flightLog', JSON.stringify(flightLog));
        }

        // --- MODAL & UI MANAGEMENT ---
        const manageModal = document.getElementById('manageModal');
        const preFlightModal = document.getElementById('preFlightModal');
        const flightLogModal = document.getElementById('flightLogModal');

        document.getElementById('manageRocketsBtn').addEventListener('click', () => openManageModal('rocket'));
        document.getElementById('manageEnginesBtn').addEventListener('click', () => openManageModal('engine'));
        document.getElementById('startPreFlightBtn').addEventListener('click', openPreFlightModal);
        document.getElementById('viewFlightLogBtn').addEventListener('click', openFlightLogModal);
        
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.onclick = () => {
                manageModal.style.display = 'none';
                preFlightModal.style.display = 'none';
                flightLogModal.style.display = 'none';
            };
        });

        // --- FLIGHT LOG & PRE-FLIGHT ---
        function openPreFlightModal() {
            populateSelect(document.getElementById('preFlightRocketSelect'), rocketList, 'rocket_name');
            populateSelect(document.getElementById('preFlightEngineSelect'), engineList, 'motor_name');
            preFlightModal.style.display = 'block';
        }

        document.getElementById('savePreFlightBtn').addEventListener('click', () => {
            const rocketId = document.getElementById('preFlightRocketSelect').value;
            const engineId = document.getElementById('preFlightEngineSelect').value;
            if (!rocketId || !engineId) {
                alert('Please select both a rocket and an engine.');
                return;
            }

            const rocketData = rocketList.find(r => r.id === rocketId);
            const engineData = engineList.find(e => e.id === engineId);
            const estimates = calculatePerformance(rocketData, engineData);

            const newFlight = {
                id: Date.now().toString(),
                flightDate: new Date().toISOString(),
                rocketId, engineId,
                rocketName: rocketData.rocket_name,
                engineName: engineData.motor_name,
                status: 'Pending',
                estimates,
                actuals: null,
                notes: '',
                rawData: ''
            };

            flightLog.unshift(newFlight);
            saveAllData();
            preFlightModal.style.display = 'none';
            openFlightLogModal();
            viewFlightDetails(newFlight.id);
        });

        function openFlightLogModal() {
            populateFlightList();
            document.getElementById('flightDetailsContainer').innerHTML = '<div class="text-center text-gray-400 p-8">Select a flight to view details.</div>';
            flightLogModal.style.display = 'block';
        }

        function populateFlightList() {
            const listEl = document.getElementById('flightList');
            listEl.innerHTML = '';
            flightLog.forEach(flight => {
                const statusColor = flight.status === 'Success' ? 'text-green-400' : flight.status === 'Failure' ? 'text-red-400' : 'text-yellow-400';
                const button = document.createElement('button');
                button.className = 'item-list-button w-full text-left';
                button.dataset.id = flight.id;
                button.innerHTML = `
                    <div class="font-bold">${flight.rocketName} / ${flight.engineName}</div>
                    <div class="text-xs text-gray-400">${new Date(flight.flightDate).toLocaleString()}</div>
                    <div class="text-sm font-semibold ${statusColor}">${flight.status}</div>
                `;
                button.onclick = () => viewFlightDetails(flight.id);
                listEl.appendChild(button);
            });
        }
        
        function viewFlightDetails(flightId) {
            const flight = flightLog.find(f => f.id === flightId);
            const container = document.getElementById('flightDetailsContainer');
            document.querySelectorAll('#flightList .item-list-button').forEach(btn => btn.classList.toggle('selected', btn.dataset.id === flightId));

            container.innerHTML = `
                <h3 class="text-xl font-bold">${flight.rocketName} with ${flight.engineName}</h3>
                <p class="text-sm text-gray-400">Date: ${new Date(flight.flightDate).toLocaleString()}</p>
                <div class="space-y-4 bg-gray-900/50 p-4 rounded-lg">
                    <div>
                        <h4 class="font-semibold text-cyan-400 mb-2">Pre-Flight Estimates</h4>
                        <p>Est. Altitude: <strong>${flight.estimates.total_altitude.toFixed(2)} m</strong></p>
                        <p>Est. Max Velocity: <strong>${flight.estimates.v.toFixed(2)} m/s</strong></p>
                        <p>Stability: <strong class="${flight.estimates.stability_calibers >= 1.0 ? 'text-green-400' : 'text-red-400'}">${flight.estimates.stability_calibers.toFixed(2)} cal</strong></p>
                    </div>
                    ${flight.status === 'Pending' ? generatePostFlightForm(flight.id) : generatePostFlightReport(flight)}
                </div>
            `;
            if(flight.status !== 'Pending' && flight.actuals) {
                 setTimeout(() => renderCharts(flightId), 100);
            }
        }

        function generatePostFlightForm(flightId) {
            return `
                <div>
                    <h4 class="font-semibold text-cyan-400 mb-2">Post-Flight Report</h4>
                    <div class="space-y-3">
                        <div>
                            <label for="flightStatus" class="text-sm">Flight Outcome:</label>
                            <select id="flightStatus" class="w-full bg-gray-700 rounded p-1 mt-1">
                                <option value="Success">Success</option>
                                <option value="Failure">Failure</option>
                            </select>
                        </div>
                        <div>
                            <label for="flightNotes" class="text-sm">Notes:</label>
                            <textarea id="flightNotes" rows="3" class="w-full bg-gray-700 rounded p-1 mt-1" placeholder="e.g., Perfect flight, slight weathercocking."></textarea>
                        </div>
                        <button onclick="saveFlightReport('${flightId}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Save Report</button>
                    </div>
                </div>
                <div>
                     <h4 class="font-semibold text-cyan-400 mb-2">Flight Computer Data</h4>
                     <textarea id="csvData" rows="6" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-xl" placeholder="Paste raw CSV data here..."></textarea>
                     <button onclick="analyzeFlightData('${flightId}')" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Analyze Flight Data</button>
                </div>
            `;
        }
        
        function generatePostFlightReport(flight) {
             return `
                <div>
                    <h4 class="font-semibold text-cyan-400 mb-2">Post-Flight Report</h4>
                    <p>Outcome: <strong class="${flight.status === 'Success' ? 'text-green-400' : 'text-red-400'}">${flight.status}</strong></p>
                    <p class="text-sm mt-2"><strong>Notes:</strong><br>${flight.notes.replace(/\n/g, '<br>') || 'No notes.'}</p>
                </div>
                ${flight.actuals ? `
                <div>
                    <h4 class="font-semibold text-cyan-400 mb-2">Actual Performance</h4>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <div class="bg-gray-700 p-2 rounded-lg"><h5 class="text-xs">Max Altitude</h5><p class="font-bold">${flight.actuals.maxAltitude.toFixed(2)} m</p></div>
                        <div class="bg-gray-700 p-2 rounded-lg"><h5 class="text-xs">Max G-Force</h5><p class="font-bold">${flight.actuals.maxGForce.toFixed(2)} G</p></div>
                        <div class="bg-gray-700 p-2 rounded-lg"><h5 class="text-xs">Top Speed</h5><p class="font-bold">${flight.actuals.maxVelocity.toFixed(2)} m/s</p></div>
                    </div>
                    <div class="mt-4 bg-gray-700 p-2 rounded-lg h-48 sm:h-64"><canvas id="altitudeChart"></canvas></div>
                    <div class="mt-4 bg-gray-700 p-2 rounded-lg h-48 sm:h-64"><canvas id="accelChart"></canvas></div>
                </div>
                ` : '<div><p>No flight computer data was analyzed.</p></div>'}
            `;
        }

        function saveFlightReport(flightId) {
            const flight = flightLog.find(f => f.id === flightId);
            flight.status = document.getElementById('flightStatus').value;
            flight.notes = document.getElementById('flightNotes').value;
            saveAllData();
            populateFlightList();
            viewFlightDetails(flightId);
        }

        // --- FLIGHT DATA ANALYSIS ---
        function analyzeFlightData(flightId) {
            const flight = flightLog.find(f => f.id === flightId);
            const csvText = document.getElementById('csvData').value.trim();
            if (!csvText) { alert('Please paste CSV data.'); return; }

            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) { alert('No data rows found.'); return; }
            
            try {
                const dataLines = lines.slice(1);
                let maxAltitude = -Infinity, maxGForce = -Infinity, maxVelocity = -Infinity, currentVelocity = 0, lastTimeS = 0;
                const basePressureHpa = (parseFloat(dataLines[0].split(',')[1]) / 4.0) / 100.0;
                const gravityG = parseFloat(dataLines[0].split(',')[4]) / 256.0;

                dataLines.forEach(line => {
                    const values = line.split(',');
                    if (values.length < 6) return;
                    const timeS = parseFloat(values[0]) / 1000.0;
                    const pressureHpa = (parseFloat(values[1]) / 4.0) / 100.0;
                    const ayG = parseFloat(values[4]) / 256.0;
                    const altitudeM = 44330.0 * (1.0 - Math.pow(pressureHpa / basePressureHpa, 0.1903));
                    const verticalAccelMs2 = (ayG - gravityG) * 9.81;
                    currentVelocity += verticalAccelMs2 * (timeS - lastTimeS);
                    lastTimeS = timeS;
                    
                    if (altitudeM > maxAltitude) maxAltitude = altitudeM;
                    if (Math.abs(ayG) > maxGForce) maxGForce = Math.abs(ayG);
                    if (currentVelocity > maxVelocity) maxVelocity = currentVelocity;
                });
                
                flight.actuals = { maxAltitude, maxGForce, maxVelocity };
                flight.rawData = csvText;
                if (flight.status === 'Pending') {
                    flight.status = document.getElementById('flightStatus').value;
                    flight.notes = document.getElementById('flightNotes').value;
                }
                saveAllData();
                populateFlightList();
                viewFlightDetails(flightId);
            } catch (error) {
                alert("Failed to parse flight data. Please check the format.");
                console.error("Analysis Error:", error);
            }
        }

        function renderCharts(flightId) {
            const flight = flightLog.find(f => f.id === flightId);
            if (!flight || !flight.actuals) return;
            
            const dataLines = flight.rawData.split('\n').filter(line => line.trim() !== '').slice(1);
            let processedData = [];
            const basePressureHpa = (parseFloat(dataLines[0].split(',')[1]) / 4.0) / 100.0;

            dataLines.forEach(line => {
                 const values = line.split(',');
                 if (values.length < 6) return;
                 const timeS = parseFloat(values[0]) / 1000.0;
                 const pressureHpa = (parseFloat(values[1]) / 4.0) / 100.0;
                 const altitudeM = 44330.0 * (1.0 - Math.pow(pressureHpa / basePressureHpa, 0.1903));
                 const axG = parseFloat(values[3]) / 256.0;
                 const ayG = parseFloat(values[4]) / 256.0;
                 const azG = parseFloat(values[5]) / 256.0;
                 processedData.push({ timeS, altitudeM, axG, ayG, azG });
            });

            const labels = processedData.map(d => d.timeS.toFixed(3));
            const gridColor = 'rgba(255, 255, 255, 0.1)', fontColor = '#e5e7eb';
            const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: fontColor } } }, scales: { x: { ticks: { color: fontColor }, grid: { color: gridColor } }, y: { ticks: { color: fontColor }, grid: { color: gridColor } } } };
            
            const altCtx = document.getElementById('altitudeChart')?.getContext('2d');
            if(altCtx) new Chart(altCtx, { type: 'line', data: { labels, datasets: [{ label: 'Altitude (m)', data: processedData.map(d => d.altitudeM), borderColor: '#6366f1', borderWidth: 2, pointRadius: 0 }] }, options: chartOptions });

            const accelCtx = document.getElementById('accelChart')?.getContext('2d');
            if(accelCtx) new Chart(accelCtx, { type: 'line', data: { labels, datasets: [ { label: 'Accel X (G)', data: processedData.map(d => d.axG), borderColor: '#ec4899', borderWidth: 2, pointRadius: 0 }, { label: 'Accel Y (G)', data: processedData.map(d => d.ayG), borderColor: '#22c55e', borderWidth: 2, pointRadius: 0 }, { label: 'Accel Z (G)', data: processedData.map(d => d.azG), borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0 } ] }, options: chartOptions });
        }
// --- PERFORMANCE ESTIMATION ---
        function calculatePerformance(rocketData, engineData) {
            const rocket = new Rocket(rocketData);
            const motor = new Motor(engineData);
            const g = 9.80665, rho = 1.2, Cd = 0.75;
            const avg_mass = rocket.dry_mass + motor.initial_mass - (motor.propellant_mass / 2.0);
            const T = motor.avg_thrust, M = avg_mass;
            if (T <= M * g) return { error: "Thrust is less than weight." };
            
            const area = Math.PI * Math.pow(rocket.radius, 2);
            const k = 0.5 * rho * Cd * area;
            const t = motor.burn_time;
            const q = Math.sqrt((T - M * g) / k);
            const x = 2 * k * q / M;
            const v = q * (1 - Math.exp(-x * t)) / (1 + Math.exp(-x * t));
            const yb_num = T - M * g - k * Math.pow(v, 2);
            const yb = (yb_num <= 0) ? 0 : (-M / (2 * k)) * Math.log(yb_num / (T - M * g));
            const yc = (M / (2 * k)) * Math.log((M * g + k * Math.pow(v, 2)) / (M * g));
            const total_altitude = yb + yc;
            const stability_calibers = (rocket.calculate_cop() - rocket.cog) / rocket.diameter;

            return { total_altitude, v, stability_calibers };
        }
        
        // --- ROCKET/ENGINE MANAGEMENT ---
        const rocketFormFields = [{ id: 'rocket_name', label: 'Rocket Name', type: 'text' }, { id: 'dry_mass_g', label: 'Dry Mass (g)', type: 'number' }, { id: 'length_cm', label: 'Length (cm)', type: 'number' }, { id: 'diameter_cm', label: 'Diameter (cm)', type: 'number' }, { id: 'nose_cone_length_cm', label: 'Nose Cone Length (cm)', type: 'number' }, { id: 'cog_cm', label: 'Center of Gravity (cm)', type: 'number' }, { id: 'num_fins', label: 'Number of Fins', type: 'number' }, { id: 'fin_root_chord_cm', label: 'Root Chord (cm)', type: 'number' }, { id: 'fin_tip_chord_cm', label: 'Tip Chord (cm)', type: 'number' }, { id: 'fin_semi_span_cm', label: 'Semi-Span (cm)', type: 'number' }, { id: 'fin_sweep_dist_cm', label: 'Sweep Distance (cm)', type: 'number' }, { id: 'nose_to_fin_dist_cm', label: 'Nose Tip to Fin Root (cm)', type: 'number' }];
        const engineFormFields = [{ id: 'motor_name', label: 'Engine Name', type: 'text' }, { id: 'motor_initial_mass_g', label: 'Initial Mass (g)', type: 'number' }, { id: 'motor_propellant_mass_g', label: 'Propellant Mass (g)', type: 'number' }, { id: 'motor_avg_thrust_n', label: 'Average Thrust (N)', type: 'number' }, { id: 'motor_burn_time_s', label: 'Burn Time (s)', type: 'number' }];
        
        function generateFormHTML(fields) { return fields.map(f => `<div class="grid grid-cols-1 sm:grid-cols-[1fr_1.5fr] gap-1 sm:gap-2 items-center"><label for="${f.id}" class="text-left sm:text-right">${f.label}:</label><input id="${f.id}" type="${f.type}" placeholder="${f.placeholder || ''}" class="bg-gray-700 rounded p-2 w-full"></div>`).join(''); }
        function openManageModal(type) {
            currentModalType = type;
            const isRocket = type === 'rocket';
            document.getElementById('modalTitle').textContent = isRocket ? 'Manage Rockets' : 'Manage Engines';
            document.getElementById('formContainer').innerHTML = generateFormHTML(isRocket ? rocketFormFields : engineFormFields);
            populateModalList();
            clearForm();
            manageModal.style.display = 'block';
        }
        function populateModalList() {
            const list = currentModalType === 'rocket' ? rocketList : engineList;
            const listEl = document.getElementById('itemList');
            listEl.innerHTML = '';
            list.forEach(item => {
                const button = document.createElement('button');
                button.className = 'item-list-button w-full text-left';
                button.textContent = item.rocket_name || item.motor_name;
                button.dataset.id = item.id;
                listEl.appendChild(button);
            });
        }
        function clearForm() {
            const fields = currentModalType === 'rocket' ? rocketFormFields : engineFormFields;
            fields.forEach(f => document.getElementById(f.id).value = '');
            editingItemId = null;
            document.getElementById('saveItemBtn').textContent = 'Save as New';
            document.getElementById('deleteItemBtn').classList.add('hidden');
            document.querySelectorAll('.item-list-button.selected').forEach(b => b.classList.remove('selected'));
        }
        function saveItem() {
            const list = currentModalType === 'rocket' ? rocketList : engineList;
            const fields = currentModalType === 'rocket' ? rocketFormFields : engineFormFields;
            const data = { id: editingItemId || Date.now().toString() };
            for (const field of fields) {
                const value = document.getElementById(field.id).value;
                if (!value) { alert(`Please fill out the "${field.label}" field.`); return; }
                data[field.id] = value;
            }
            if (editingItemId) {
                const index = list.findIndex(item => item.id === editingItemId);
                list[index] = data;
            } else {
                list.push(data);
            }
            saveAllData();
            manageModal.style.display = 'none';
        }
        function deleteItem() {
            if (!editingItemId || !confirm('Are you sure?')) return;
            if (currentModalType === 'rocket') rocketList = rocketList.filter(item => item.id !== editingItemId);
            else engineList = engineList.filter(item => item.id !== editingItemId);
            saveAllData();
            populateModalList();
            clearForm();
        }
        function populateSelect(selectEl, list, nameKey) {
            selectEl.innerHTML = '<option value="">-- Select --</option>';
            list.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[nameKey];
                selectEl.appendChild(option);
            });
        }
        document.getElementById('itemList').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const id = e.target.dataset.id;
                const list = currentModalType === 'rocket' ? rocketList : engineList;
                const itemData = list.find(item => item.id === id);
                if (itemData) {
                    const fields = currentModalType === 'rocket' ? rocketFormFields : engineFormFields;
                    fields.forEach(f => document.getElementById(f.id).value = itemData[f.id]);
                    editingItemId = id;
                    document.getElementById('saveItemBtn').textContent = 'Save Changes';
                    document.getElementById('deleteItemBtn').classList.remove('hidden');
                    document.querySelectorAll('.item-list-button.selected').forEach(b => b.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            }
        });
        document.getElementById('newItemBtn').addEventListener('click', clearForm);
        document.getElementById('saveItemBtn').addEventListener('click', saveItem);
        document.getElementById('deleteItemBtn').addEventListener('click', deleteItem);

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
